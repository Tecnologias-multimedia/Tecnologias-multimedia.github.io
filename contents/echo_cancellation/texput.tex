% Emacs, this is -*-latex-*-

\title{Echo Cancellation}

\maketitle

\section{Description}


One of the first problems we encounter when we use the
\texttt{buffer.py} version of InterCom is that if we don't use
headphones, the sound that comes out of our PC's speaker reaches our
microphone and some time later, that sound reaches our interlocutor in
the form of an echo, which is reproduced by his speaker, which is
captured again by his microphone, and so on, until generating a rather
unpleasant feedback.

One way to minimize this problem is (apart from using headphones) to
reduce as much as possible (as long as it is audible, of course) the
gain of the amplifier that feeds our speaker. Unfortunately, this is
not always possible, among other reasons, because if the volume is too
low, we will not hear our interlocutor.

Another way is to subtract from the signal that our microphone picks
up ${\mathbf m}$, the signal that our speaker is reproducing
${\mathbf s}$, resulting in an echo cancellation, and therefore, of
the coupling that it generates. The key in this process is to find
out:

\begin{enumerate}
\item What delay $d$ exists between the time the received signal
  ${\mathbf s}$ is reproduced by our speaker until the said signal is
  captured by our ADC? This time will depend fundamentally on the
  distance between the speaker/s and the mic of our PC, and we can
  assume that it is constant.

\item What attenuation $a$ should be applied to ${\mathbf s}$ to
  achieve the elimination of the sent signal.
\end{enumerate}

If we have calculated $d$ and $a$ correctly, echo cancellation will
occur after performing the operation
\begin{equation}
   {\mathbf c}_i = {\mathbf m}_i - a{\mathbf s}_{i+d},
\end{equation}
where $\{{\mathbf c}_i\}$ is the signal sent with the echo cancelled.

Since $d$ depends exclusively on the physical configuration of our PC
(assuming that there are no other sources of echo, such as walls), we
can estimate its value before starting the conversation by locally
generating a sound through our speaker that it is easy to locate in
time after being digitized by our microphone, and measuring with a
stopwatch the time that elapses from when the sound is reproduced
until it is registered again.

To calculate $a$ what we can do is check if, in the absence of local
sound (only having the speaker as sound source),
${\mathbf c}={\mathbf 0}$, that is, if we have canceled the echo. If
the energy of ${\mathbf c}$ is not zero, then the value of $a$ is too
high or too low. So what we will do is increase $a$ and see if the
energy decreases, and if it doesn't, then we will decrease $a$. In
general we will never cancel the echo completely, but we should always
be able to find a value for $a$ that minimizes the energy
${\mathbf c}$ (as long as we are silent).

\section{Deliverables}

A Python module called \texttt{cancel\_echo.py} that inherits from
\texttt{buffer.py} and that implements the previously presented idea.

\section{Resources}

\bibliography{networking,nat}
