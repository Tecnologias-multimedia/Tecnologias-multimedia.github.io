% Emacs, this is -*-latex-*-

\title{Echo Cancellation}

\maketitle


\section{The problem}

One of the first problems we encounter with the use the
\texttt{buffer.py} module\footnote{And obviously, any other parent
  version of \texttt{buffer.py}.} is that, if we don't use headphones,
the sound that comes out of our PC's speaker reaches our microphone
some time later, and more some time later, that sound reaches our
interlocutor in the form of an echo, which is reproduced by his/her
speaker, which can be captured again (some time later) by his
microphone and sent it back to us ... and so on, generating a rather
unpleasant feedback (echo) signal. In other words, if ${\mathbf s}$ is
the (analog) signal played by our speaker and that reaches our
mic(rophone), ${\mathbf n}$ is the signal emited by me (usually called
the ``near-end'' person\footnote{Our interlocutor would be the
  ``far-end'' person.} that reaches our mic (i.e., the same signal
that would be captured by our mic if I were using a headset), and
${\mathbf m}$ is the (mixed) signal recorded by our microphone (when
the headset is not used), we have that

\begin{equation}
  m(t) = n(t) + s(t),
  \label{eq:echo_problem}
\end{equation}
where $m(t)$ is the signal that hits the membrane of our mic.

Our problem here is to minimize the energy of $s(t)$.

\section{The trivial (and definitive) solution}

Use a headset. In this case,
\begin{equation}
  m(t) \approx n(t)
  \label{eq:headset_solution}
\end{equation}
because $s(t)\approx 0$.

\section{The trivial (but limited) solution}

Decrease the gain of our speaker to do $s(t)\approx 0$. Unfortunately
this also decreases the volume of the far-end signal (the voice of our
interlocutor) :-/

\section{The simplest substract solution}
Lets ${\mathbf m}$ the digital version of $m(t)$ and ${\mathbf m}[i]$
it's $i$-the frame. In this solution, we send
\begin{equation}
  \tilde{\mathbf n}[i] = {\mathbf m}[i] - a{\mathbf s}[i-d],
  \label{eq:simplest}
\end{equation}
where $a$ is an attenuation (scalar) value and $d$ represents the
delay (measured in frame-times) required to propagate the sound from
our speaker to our mic.

\section{Considering the frequency response of the near-end}
We can improve the performance of the echo cancellation process if we
take also into consideration that echo signal that finally reaches our mic
is the convolution of $s(t)$ and the signal $h(t)$ that represents
the echo response of our local audioset (speaker, mic, walls, monitor,
keyboard, our body, etc.) to the impulse signal $\delta(t)$. In other
``words'', we can compute
\begin{equation}
  \tilde{\mathbf n}[i] = {\mathbf m}[i] - ({\mathbf s}*{\mathbf h})[i-d],
  \label{eq:simplest}
\end{equation}
where $*$ represents the convolution between digital signals, and
${\mathbf h}$ is the digitalized (discrete + quantized) version of
$h(t)$, the response of the near audioset to $\delta(t)$.

The convolution of digital signals in the time domain can be expensive
$(O^2$) if the number of samples is high. Fortunately, thanks to the
theorem of the convolution of signals in the frequency
domain~\cite{kovacevic2013fourier,Oppenheim2}, the convolution can be
replaced by the dot product, when we consider the signals in the
frequency domain. Thanks to this, we can rewrite the
Eq.~\eqref{eq:simplest} as
\begin{equation}
  \tilde{\mathbf n}[i] = {\mathbf m}[i] - {\mathcal F}^{-1}\{{\mathbf S}{\mathbf H}\}[i-d],
  \label{eq:simplest_and_faster}
\end{equation}
where ${\mathbf S}$ is the Fourier transform\footnote{The Fourier
  transform is an special case of the Laplace transform where
  $\sigma=0$ in the Laplace domain represented by the complex numbers
  $s=\sigma+j\omega$. This simplification can be used for the
  characterization of our local-end audioset because it can be
  considered a FIR (Finite Impulse Response) system (in ausence of an
  audio signal, the echo always decays with the time).} of
${\mathbf s}$, ${\mathbf H}$ is the Fourier transform of
${\mathbf h}$, and ${\mathcal F}^{-1}$ represents the inverse Fourier
transform. Notice that all these transforms are applied to digital
signals, and there exist fast algorithms ($O\log_2O$).

\section{Adaptive Filtering using LMS (Least Mean Squares)}

Adaptive filters are a class of filters that, to achieve a desired
result (such as an echo cancellation), self-adjust their coefficients
based on the values of the input signal. This adjustment is done
dynamically (ideally, in real-time), allowing the filter to adapt to
changes in the environment (e.g., room acoustics variations).

The LMS (Least Mean Squares) algorithm is an iterative and adaptive
algorithm designed to minimize the mean square error
\begin{equation}
  
\end{equation}

between the microphone
input $m$ (the desired signal without the echo), and the filter
output, the estimated echo $\hat{\mathbf m}$.

\begin{enumerate}
\item Estimate the echo (using the current filter coefficients ${\mathbf h}_i$):
  \begin{equation}
    {\mathbf m}[i] = h_0{\mathbf s}[i] + h_1{\mathbf s}[i-1] + \cdots + h_{N-1}{\mathbf s}[i-(N-1)]
  \end{equation}

\section{Deliverables}

A Python module called \texttt{echo\_cancellation.py} that inherits from
\texttt{buffer.py} and that implements at least one of the previously
described solutions. More concretely:
\begin{enumerate}
\item If you implement the ``delay and substract solution'', you must
  estimate $a$, $d$ and perform the signals substraction to remove the
  echo signal. For example, Skype finds $d$ and $a$ using a ``call
  signal'' (a sequence of more-or-less tonal sounds). $d$ is
  determined measuring the propagation time of the call signal between
  our speaker and our mic, and $a$ measuring the ratio between the
  energy of the call signal played and the energy of the call signal
  recorded.
\item If you also consider the (discrete) frequency response of the
  near-end audioset to estimate a better echo signal, first you will
  need to find ${\mathbf H}$ (the discrete frequency response of the
  audioset). For this, the local-end speaker should generate an
  impulse signal ${\mathbf \delta}$, and in absence of any other sound
  signal, record the echo and compute its Fourier transform. Likely,
  it is a good idea to repeat this process several times to obtain a
  better estimation of ${\mathbf H}$. Finally, notice that
  ${\mathbf H}[\omega]$ (the $\omega$-th frequency component of
  ${\mathbf H}$) is a complex number.
\item In both cases (simple delay and substract solution and
  considering also the frequency response of the near-end audioset),
  the parameters that determine the estimation of the echo signal
  should be continously\footnote{A 1-seconds cadence should be
    enought.} monitored becase the physical structure of the near-end
  audioset can be dynamic (for example, the inclination of the screen
  of our laptop can be modified).

\end{enumerate}

\section{Resources}

\bibliography{signal_processing}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{comment}
http://www.seas.ucla.edu/dsplab/index.html
https://es.mathworks.com/help/signal/ug/echo-cancelation.html
https://dsp.stackexchange.com/questions/26617/echo-cancelling-using-autocorrelation-function
https://pypi.org/project/adaptfilt/
http://www.diva-portal.org/smash/get/diva2:280596/fulltext01
https://github.com/ThomasHaubner/e2e_dnn_ad_control_for_lin_aec
https://scicoding.com/4-ways-of-calculating-autocorrelation-in-python/



where ${\mathbf m}[i]$ is the $i$-th sample of the signal
${\mathbf m} = \{{\mathbf m}[i]\}$, $a$ is a real number that expresses
an attenuation\footnote{Usually, $a<1$ because in general the amount
  of signal that our micro captures from our speaker is smaller (in
  \href{https://en.wikipedia.org/wiki/Energy_(signal_processing)}{energy}~\cite{vetterli2014foundations})
  than the signal ${\mathbf s}$.}, and $d$ is an integer number that
indicates the delay (in sample-times\footnote{A sample-time is the
  interval of time that separates two consecutive samples (or frames)
  and depends on the sampling frequency.}) that exists between when
the received signal ${\mathbf s}$ is reproduced by our speaker until
such signal is captured by our ADC (Analog Digital Converter).

\section{The trivial partial solution}
One way to minimize this problem\footnote{Apart from using headphones,
  which is by far the better solution.} is to reduce as much as
possible (as long as it is audible, of course) the gain of the
amplifier that feeds our speaker(s). In terms of the
Eq.~\eqref{eq:echo_problem}, this means to make $a$ close to
zero. Unfortunately, this is not always possible, among other reasons,
because if the volume is too low, we will not hear our interlocutor
(the ``far-end'').


\section{Delay and substract solution}

Another simple\footnote{The AEC (Audio Echo Cancellation) problem has
  been extensively estudied and there are several solutions. This one
  is probably the simplest one.} solution is to determine $a$ and $d$,
and compute
\begin{equation}
  {\mathbf n}[i] = {\mathbf m}[i] - a{\mathbf s}[i-d].
  \label{eq:echo_cancellation}
\end{equation}

$d$ can be found by measuring the time that a played signal spends to
be recorded by our mic, and $a$ computing the ratio between the
energies of ${\mathbf s}$ (the played signal) and ${\mathbf m}$ (the
recorded signal). For example, Skype finds $d$ and $a$ at the
beginning of the session using a ``call signal'' (a sequence of
more-or-less tonal sounds).

\subsection{Considering the frequency respose of the near-end audioset}
In general, Eq.~\eqref{eq:echo_problem} is oversimplified because our
local audioset (speaker, mic, walls, our body, etc.) does not have a
flat response in the frequency domain. Therefore, a more realistic
model of the echo effect is
\begin{equation}
   {\mathbf m}[i] = {\mathbf n}[i] + \{f({\mathbf s})\}[i-d],
  \label{eq:more_realistic_echo_problem}
\end{equation}
where $f({\mathcal s})$ is a filtered version of the signal
${\mathbf s}$, in which some frequencies are partially attenuated
(notice that now there is a possiblely different $a$-value for each
frequency of ${\mathbf s}$).

Now the problem (apart from finding $d$, obviously) is how to
determine $f(\cdot)$. Again, a simple way of doing this is to use a
call signal to measure the frequency response of the near-end
audioset. For this, a good call signal can be a sequence of
impulses\footnote{A impulse generates a flat
  \href{https://en.wikipedia.org/wiki/Spectral_density}{spectrum}~\cite{kovacevic2013fourier,Oppenheim2}
  for a short period of time.} of a sequence of uniform random noise
signals\footnote{Uniform random noise (or
  \href{https://en.wikipedia.org/wiki/White_noise}{white noise}) has a
  flat spectrum.}. Notice that the frequency response (the filter
coefficients of $f(\cdot)$) can be found comparing the flat spectrum
signal ${\mathbf s}$ generated by the speaker with the supposedly
non-flat spectrum of the signal ${\mathbf m}$ captured by the
microphone. To apply $f(\cdot)$ we can multiply
${\mathcal F}({\mathbf s})$ by the filter coefficients of $f(\cdot)$
in the Fourier domain, being ${\mathcal F}(\cdot)$ the Fourier
Transform~\cite{kovacevic2013fourier,Oppenheim2}.


Lets $H(s)$ the representation of $h(t)$ in the frequency (Laplace)
domain, where $s=\sigma+j\omega$ is a complex number that denotes a
frequency component.

If we consider that $h(t)$ in the frequency domain is denoted by
$H(s)$, (when $s=\sigma+j\omega$ we say that $H(s)$ is the Laplace
Transform of $h(t)$), that $S(s)$ is the representation in the
frequency domain of the signal $s(t)$, and that in our specific case,
where our near-end audioset is a FIR (Finite Impulse Response)
system\footnote{In ausence of an audio signal, the echo always decays
  with the time.}, we can also characterize it using the Fourier
Transform (where $sigma=0$), i.e., we can say that $H(j\omega)$ (the
Fourier Transform of $h(t)$) describes our local audioset from a
frequency perspective. Considering now the convolution theorem in the
Fourier domain, we can rewrite the Eq.~\eqref{eq:simplest} as
\begin{equation}
  \tilde{\mathbf n}[i] = {\mathbf m}[i] - {\mathbf h}({\mathbf S}{\mathbf H})[i-d],
  \label{eq:simplest2}
\end{equation}
where ${\mathbf S}$ is the Fast Discrete Fourier Transform of
${\mathbf s}$ and ${\mathbf H}$ is the Fast Discrete Fourier Transform
of ${\mathbf h}$, and ${\mathcal F}^{-1}$ represents the Fast Inverse
Discrete Fourier Transform.

Therefore, as it can be seen in Eq.~\eqref{eq:simplest2}, to find the
echo signal we need to mulplity  ${\mathbf S}$ (the played signal in the Fourier
domain) by ${\mathbf H}$ (the frequency response of the near-end
audioset).

\end{comment}