\title{\href{https://www.ual.es/estudios/grados/presentacion/plandeestudios/asignatura/4015/40154321?idioma=zh_CN}{TecnologÃ­as Multimedia} - Study Guide - Milestone 3: ``wiring'' the ADC with the DAC}

\maketitle

\section{Description}

Let's start our development of InterCom with a simple program that
inputs digital audio (through the
\href{https://en.wikipedia.org/wiki/Analog-to-digital_converter}{ADC}
of your computer) and, as soon as possible, outputs it (through the
\href{https://en.wikipedia.org/wiki/Digital-to-analog_converter}{DAC}). We
are going to use a minimal ``wiring'' program, that when it is run and
we feed back the audio output with the audio input of our computer,
allows us to measure
its \href{https://en.wikipedia.org/wiki/Latency_(engineering)}{latency}. To
handle the audio hardware we use
\href{https://python-sounddevice.readthedocs.io}{\texttt{sounddevice}}
\cite{sounddevice}, that is wrapper for the
\href{http://www.portaudio.com/}{PortAudio} library.

\section{What you have to do?}

\begin{enumerate}

\item Refresh some (probably high-school) ideas about
  \href{https://vicente-gonzalez-ruiz.github.io/the_sound/}{The
    Sound}, \href{https://vicente-gonzalez-ruiz.github.io/human_auditory_system/}{The
    Human Auditory System},
    and \href{https://vicente-gonzalez-ruiz.github.io/human_sound_perception/}{The
    Human Sound Perception}. Notice that we are able to perceive
    sounds whose frequency ranges between 20 Hz and 20 KHz
    (approximately), and that a speaker is basically a microphone, and
    viceversa.
  
\item Download the Python
  \href{https://docs.python.org/3/tutorial/modules.html}{module}
  \href{https://raw.githubusercontent.com/Tecnologias-multimedia/intercom/master/test/sounddevice/wire3.py}{wire3.py}. This module, basically:
  
  \begin{pseudocode}[display]{}{}
    \BEGIN
      \mathtt{CHUNK\_SIZE} \GETS 1024\\
      \WHILE \TRUE
      \BEGIN
        \mathtt{chunk} \GETS \mathtt{stream}.\mathtt{read}(\mathtt{CHUNK\_SIZE}) \STMTNUM{1in}{st.1}\\
        \mathtt{stream}.\mathtt{write}(\mathtt{chunk}) \STMTNUM{1.03in}{st.2}
      \END
    \END
  \end{pseudocode}

  where (1) captures $\mathtt{CHUNK\_SIZE}$ frames from the sound
  card, and (2) plays the chunk of frames
  $\mathtt{chunk}$. In \texttt{sounddevice} a frame is a collection of
  one or more samples (typically, a frame is a single sample if the
  number of channels is 1, or two samples if the number of channels is
  2).

\item If you want to run this module right now, check first that the
  output volumen of your speakers is not too high, otherwise you could
  ``couple'' the speaker and the mic(rophone) of your computer,
  producing a loud and annoying sound. In order to mitigate this
  effect, you can also control the record gain of your mic (if the
  gain is 0, no feedback between the speaker and the mic will be
  possible). In Xubuntu, these controls are available by clicking in
  the speaker icon (situated in the top right corner of your screen)
  of the XFCE window manager.

\item OK, run it, with:

  \begin{lstlisting}[language=Bash]
    python wire3.py
  \end{lstlisting}
  
  althought probably you will obtain the error:
  
  \begin{lstlisting}[language=Bash]
    nose
  \end{lstlisting}

  This is solved by intalling the
  \href{https://python-sounddevice.readthedocs.io/en/latest/}{python-sounddevice}
  \cite{sounddevice} module with:

  \begin{lstlisting}[language=Bash]
    pip install sounddevice
  \end{lstlisting}

\item Now, lets compute, experimentally, the \texttt{wire3.py}
  latency.

  \begin{enumerate} \item First, we need the
  tools \href{http://sox.sourceforge.net/}{SoX}, \href{https://www.audacityteam.org/}{Audacity}
  and \href{https://raw.githubusercontent.com/Tecnologias-multimedia/intercom/master/test/sounddevice/wire3.py}{wire3.py}:
  
    \begin{lstlisting}[language=Bash]
      sudo apt install sox
      sudo apt install audacity
      curl https://raw.githubusercontent.com/Tecnologias-multimedia/intercom/master/test/sounddevice/plot_input.py > plot_input.py
    \end{lstlisting}

  \item Run:

    \begin{lstlisting}[language=Bash]
      python plot_input.py
    \end{lstlisting}

    and check that the gain of the mic does not
    produce \href{https://en.wikipedia.org/wiki/Clipping_(audio)}{clipping}
    during the sound recording.

  \item Run:

    \begin{lstlisting}[language=Bash]
      sox -t alsa default test.wav
    \end{lstlisting}

    to save the ADC's output to a file, and in a different terminal,
    run:

    \begin{lstlisting}[language=Bash]
      python wire3.py
    \end{lstlisting}

    while you control the output volume of the speakers to produce a
    decaying coupling effect between both devices (the speaker(s) and
    the mic). If your desktop has not
    these \href{https://en.wikipedia.org/wiki/Transducer}{transducers},
    we can use
    a \href{https://www.google.com/search?q=male+to+male+audio+jack+cable&client=firefox-b-d&sxsrf=ALeKk00GZUDGqiOfc0D8xkA_MIYgCuZmSA:1600270049146&source=lnms&tbm=isch&sa=X&ved=2ahUKEwjdvsu-_u3rAhXl0eAKHS90DUoQ_AUoAXoECA0QAw&biw=4288&bih=972}{male-to-male
    jack audio cable} and connect the input and the output of your
    sound card.

  \item While \texttt{sox} is recording, produce some short sound (for
    example, hit your laptop or your micro with one or your nails). Do
    this at least a couple of times more, to be sure that you record
    the sound and the feedback of such sound. It's important the sound
    to be short (a few miliseconds) in order to recognize it and it's
    replicas.

  \item Stop \texttt{sox} with CTRL+C keys.

  \item Load the sound file into Audacity:
    
    \begin{lstlisting}[language=Bash]
      audacity test.wav
    \end{lstlisting}

    and localize one of your sounds.

  \item Now, move the Audacity's audio-cursor and localize the first
    replica (there could be more than 1).

  \item Measure the time between the ocurrence of the short sound and
    it's first replica. This time is the real latency of your computer
    runing \texttt{wire3.py}.

  \item Modify the ``constant'' $\mathtt{CHUNK\_SIZE}$ and repeat this
    process starting at the Step X.Y. Which percentaje (or ratio)
    between the physical latency and $\mathtt{CHUNK\_SIZE}$ holds?

  \end{enumerate}

\item At this point, we know the real physical latency of the
  $\mathtmodule. Let's compute now the teoretical latency. Consider the basic audio configuration

A you can see in the code of \texttt{wire3.py}:

\begin{lstlisting}[language=Python]
import sounddevice as sd
\end{lstlisting}

we are using the
 to access to the sound hardware.

Next, we create a I/O raw audio stream
using \href{https://python-sounddevice.readthedocs.io/en/latest/api/raw-streams.html#sounddevice.RawStream}{sounddevice.RawStream()},
using
\begin{lstlisting}[language=Python]
stream = sd.RawStream(samplerate=44100, channels=2, dtype='int16')
\end{lstlisting}

As you can see in \cite{sounddevice}, this constructor method accepts
several parameters. In our example we have used only the most
relevants for us right now:
\begin{enumerate}
\item The samling rate.
\item The number of channels.
\item The number of bits of each sample.
\end{enumerate}
Please, refeer \cite{harmonic-analysis} for knowing more detailed
information about these parameters.

Please, review the modules of documentation 

Next, we define a chunk size
\begin{lstlisting}[language=Python]
CHUNK_SIZE = 1024
\end{lstlisting}
for the block of data we are going to capture in the loop that will
be defined just below.

The loop is an infinite loop

\item Measure the theoretical latency.

\item Write a pulse generator that periodically plays a very short
  sound, and where we can control the period.

\item Capture this sound with \texttt{wire3.py} and modify the period
  until you hear that the input and the output are synchronized.

\item Compute the period in secods, this is also the latency of
  \texttt{wire3.py}.

\item Compute the difference between this latency and the theoretical
  one.

\end{enumerate}

\section{Resources}

\bibliography{python}
