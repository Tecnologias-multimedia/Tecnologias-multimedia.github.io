\input{../definitions}
\title{Linux audio basics and \texttt{sounddevice}}

\maketitle

\section{The Linux Audio (probably partial) Stack}

\begin{center}
\begin{tabular}{|c|c|}
\hline
\multicolumn{2}{c}{\href{https://en.wikipedia.org/wiki/List\_of\_Linux\_audio\_software}{Linux Audio Applications}} \\
\hline
\href{https://jackaudio.org/}{JACK} & \href{https://www.freedesktop.org/wiki/Software/PulseAudio/}{Pulse Audio} \\
\hline
\multicolumn{2}{c}{\href{https://www.alsa-project.org}{ALSA}} \\
\hline
\multicolumn{2}{c}{\href{https://www.alsa-project.org/wiki/Matrix:Main}{Sound hardware}} \\
\hline
\end{tabular}
\end{center}

\section{Advanced Linux Sound Architecture (ALSA)}
ALSA is a software
\href{https://docs.kernel.org/sound/kernel-api/index.html}{framework}
and part of the Linux kernel (as a set of
\href{https://wiki.archlinux.org/title/Kernel_module}{modules}) that
provides an application programming interface (API), in
\href{https://en.wikipedia.org/wiki/C_(programming_language)}{C}, for
sound device drivers~\cite{phillips2005user}. For example, to show the
modules related with ALSA currently loaded, run:
\begin{verbatim}
lsmod | grep '^snd' | column -t
\end{verbatim}

\subsection{\texttt{amixer} and \texttt{alsamixer}}
\texttt{\href{https://linux.die.net/man/1/amixer}{amixer}} (through the command line) and \texttt{\href{https://en.wikipedia.org/wiki/Alsamixer}{alsamixer}} (using also the command line but being ncurses-based) can be used to control the gain of the audio inputs and outputs. For example, to run \texttt{alsamixer}, in your terminal write:
\begin{verbatim}
alsamixer
\end{verbatim}

\subsection{\texttt{arecord}}
\texttt{\href{https://linux.die.net/man/1/arecord}{arecord}} runs on
ALSA to capture
\href{https://en.wikipedia.org/wiki/Pulse-code_modulation}{PCM (Pulse
  Code Modulation)} (by default, using the
\href{https://en.wikipedia.org/wiki/WAV}{WAV} audio format) audio
data, and provides information about the hardware, and also, about the
audio servers. Some examples of use are:

\begin{itemize}

\item List the physical audio \href{https://en.wikipedia.org/wiki/Analog-to-digital_converter}{ADC}(s):
\begin{verbatim}
arecord -l      
\end{verbatim}

\item Show information about the ADC(s) capabilities (if \href{https://www.freedesktop.org/wiki/Software/PulseAudio/}{PulseAudio} is not running, remove \texttt{pasuspender --}):
\begin{verbatim}
pasuspender -- arecord -D hw:0,0 --dump-hw-params
\end{verbatim}

\item Idem, but using the default audio server (usually, PulseAudio):
\begin{verbatim}
arecord --dump-hw-params > /dev/null
\end{verbatim}
Usually, the software capabilities are higher than the hardware ones.

\item List the virtual ADC(s) (\href{https://alsa.opensrc.org/Pcm-device}{PCM} outputs):
\begin{verbatim}
arecord -L
\end{verbatim}

\item Record raw (without header) audio in \href{https://en.wikipedia.org/wiki/Compact_Disc_Digital_Audio#Audio_format}{CD audio format}:
\begin{verbatim}
arecord -t raw -f cd > signed_int16_bits__little_endian__44100_frames_per_second__2_samples_per_frame.raw
\end{verbatim}

\end{itemize}

\subsection{\texttt{aplay}}
\texttt{\href{https://linux.die.net/man/1/aplay}{aplay}} is the
companion PCM player of \texttt{arecord}. The playing capabilities
used to be exactly the same than the provides by \texttt{arecord}.

\begin{itemize}

\item List the physical audio \href{https://en.wikipedia.org/wiki/Digital-to-analog_converter}{DAC}(s):
\begin{verbatim}
aplay -l      
\end{verbatim}

\item Idem, but listing the virtual DACs (PCM outputs):
\begin{verbatim}
aplay -L
\end{verbatim}

\item (Recording and) Playing directly through ALSA, using the physical DAC and DAC:
\begin{verbatim}
arecord -t raw -f cd | aplay -t raw -f cd
pasuspender -- arecord -D hw:0,0 -t raw -f cd | pasuspender -- aplay -D hw:0,0 -t raw -f cd
\end{verbatim}

\item (Recording and) Playing throught the default sound server (usually PulseAudio), using the virtual DAC and DAC:
\begin{verbatim}
arecord -t raw -f cd | aplay -t raw -f cd
\end{verbatim}
\end{itemize}

\subsection{\texttt{speaker-test}}
\texttt{\href{https://linux.die.net/man/1/speaker-test}{speaker-test}} allows to generate (by default) \href{https://en.wikipedia.org/wiki/Pink_noise}{pink noise} or a pure tone through the audio outputs. Examples:
\begin{verbatim}
speaker-test                       # Analog (copper or Bluetooth, if available) mono
speaker-test -c 2                  # Analog (copper of Bluethooh, if available) stereo
speaker-test -Dplug:spdif -c2      # Digital (SPDIF) stereo, if available
speaker-test -c 8                  # Surround (usually through HDMI) 7.1, if available
\end{verbatim}

\section{PulseAudio}

\href{https://www.freedesktop.org/wiki/Software/PulseAudio/}{PulseAudio
  is a sound server system for POSIX OSes, meaning that it is a proxy
  for your sound applications. It is an integral part of all relevant
  modern Linux distributions and is used in various mobile devices, by
  multiple vendors. It performs advanced operations on sound data as
  it passes between your application and hardware. Things like
  transferring audio to a different machine, changing the sample
  format or channel count, or mixing several sounds into one
  input/output, are easily achieved using
  PulseAudio.}~\cite{newmarch2017pulseaudio}

Like ALSA, PulseAudio is dinamically configured using
PulseAudio\href{https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/Modules/}{modules}. \texttt{\href{https://linux.die.net/man/1/pactl}{pactl}}
is the command line tool for loading and downloading modules. For
example, to use the equalizer
\texttt{\href{https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/Equalizer/}{qpaeq}}
that should be already installed in your computer if you are using
PulseAudio, run:

\begin{verbatim}
pactl load-module module-equalizer-sink
pulseaudio --kill && pulseaudio --start
qpaeq &
\end{verbatim}
% Ver tambi√©n: pulseaudio-equalizer-ladspa

Another important PulseAudio application is the
\texttt{\href{https://freedesktop.org/software/pulseaudio/pavucontrol/}{pavcontrol}}
that is a mixer/VU-meter that handles sound applications, input and
output audio devices.

\section{JACK}

Like PulseAudio, \href{http://jackaudio.org/}{JACK} (JACK Audio
Connection Kit) is sound server that proxies between the audio
applications (that must use JACK) and ALSA. JACK is the right choice
if latency is important for you because it can be configured. Another
interesting feature of JACK is that allows to define the connections
(audio flows) between JACK-client applications (like in a real mixer
desk). Finally, if you use MIDI apps and/or MIDI hardware, rely on
JACK.

All the functionality of JACK can be get through running
\href{https://qjackctl.sourceforge.io/}{QjackCtl}:
\begin{verbatim}
qjackctl &
\end{verbatim}
that is a GUI for configuring the JACK server parameters and define the audio flows. Usually, the following options are available:
\begin{enumerate}
\item \texttt{Start:} the server.
\item \texttt{Stop:} the server.
\item \texttt{Quit:} kill the server.
\item \texttt{Messages:} from the server.
\item \texttt{Session:} show/hide the session manager window.
\item \texttt{Setup:} the server. 
\item \texttt{Connect:} the audio
  applications. \href{http://www.rncbc.org/drupal/node/76}{Notice
    that} all connections made in the Connections interface are kept
  as long you don't power-cycle the JACK server (jackd). That is, all
  connections will be lost when the JACK server or any of the client
  application programs are closed or terminated.
\item \texttt{Patchbay:} will keep all declared connections
  automatically, as long as QjackCtl is kept alive. Moreover, you can
  declare typical connection configuration that are carried out when
  the related clients are executed.
\item Play: start transport
  \href{https://jackaudio.org/api/group__MIDIAPI.html}{timming
    events}.
\item Pause: stop transport timming events.
\item Forward: transport timming events.
\item Backward: transport timming event.
\item Rewind: transport timming event.
\end{enumerate}

\section{sounddevice}
\href{https://python-sounddevice.readthedocs.io}{sounddevice} is a
Python \href{https://docs.python.org/3/tutorial/modules.html}{module}
that provides bindings for the
\href{http://www.portaudio.com/}{PortAudio
  library}~\cite{sounddevice}.

Let's see some examples of what sounddevice can do:

\subsection*{Wiring the ADC and the DAC using a loop}
\lstinputlisting[language=Python]{/home/vruiz/intercom/test/sounddevice/wire5.py}

\subsection*{Wiring the ADC and the DAC using an interruption handler}
\lstinputlisting[language=Python]{/home/vruiz/intercom/test/sounddevice/wire.py}

\section{Resources}

\bibliography{python,sound}
